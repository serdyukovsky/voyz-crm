# Анализ роли systemFields в импорте

## 1. Роль systemFields в процессе импорта

### 1.1. Нормализация строк
**Использование**: НЕ используется
- Нормализация происходит в `mapDealRow()` через прямые обращения к `mapping`
- Пример: `getValue(mapping.title)`, `getValue(mapping.amount)`
- `systemFields` не участвуют в процессе нормализации

### 1.2. Валидация
**Использование**: НЕ используется напрямую
- Валидация mapping происходит через жестко закодированные проверки:
  - `mapping.title` обязателен (строка 548, 221)
  - `mapping.pipelineId` удаляется из mapping (строка 545)
- Валидация строк происходит через прямые проверки:
  - `titleValue` обязателен (строка 1837)
  - `pipelineId` обязателен (строка 795)
- `systemFields` НЕ используются для валидации

### 1.3. Построение dealsWithNumber
**Использование**: НЕ используется
- `dealsWithNumber` строится из `validRows` через прямые обращения к полям:
  - `row.stageId`, `row.title`, `row.pipelineId` (строки 1358-1364)
- `systemFields` не участвуют в построении

## 2. Где systemFields реально используются

### 2.1. Только для UI (метаданные)
- **Место**: `getImportMeta()` → `getMixedImportMeta()` → `getDealsImportMeta()`
- **Назначение**: Предоставить фронтенду список доступных полей для маппинга
- **Использование на фронтенде**: 
  - Показ полей в UI для выбора маппинга
  - Автоматическое сопоставление (auto-mapping)
  - Валидация на фронтенде (опционально)

### 2.2. НЕ используются в backend логике импорта
- `importDeals()` не использует `systemFields`
- `mapDealRow()` не использует `systemFields`
- Валидация не использует `systemFields`

## 3. Может ли импорт работать, если systemFields = [] или undefined?

### 3.1. Технически ДА
- Backend импорт работает независимо от `systemFields`
- Если `mapping` передан корректно, импорт выполнится
- Пример: если фронтенд передает `{ title: "Column A", amount: "Column B" }`, импорт работает

### 3.2. Практически НЕТ (silent fail)
- Если `systemFields = []` или `undefined`:
  - Фронтенд не может показать поля для маппинга
  - Пользователь не может создать корректный mapping
  - Импорт не может быть инициирован пользователем
  - Это silent fail на уровне UX

### 3.3. Индикатор проблем
- Если `systemFields = []`, это означает:
  - `getDealsImportMeta()` вернул пустой массив
  - Это может быть индикатором более серьезной проблемы
  - Например, если код `getDealsImportMeta()` изменился и не возвращает поля

## 4. Критичность для работы импорта

### 4.1. Backend импорт: НЕ критично
- Backend может работать без `systemFields`
- Но это плохая практика - нет валидации mapping против доступных полей

### 4.2. Frontend импорт: КРИТИЧНО
- Без `systemFields` пользователь не может создать mapping
- Импорт не может быть инициирован
- Это silent fail на уровне UX

### 4.3. Архитектурная проблема
- Отсутствие валидации mapping против `systemFields` на backend
- Это позволяет передать несуществующие поля в mapping
- Может привести к silent fail при обработке строк

## 5. Предложение: Runtime-проверка и фатальная ошибка

### 5.1. Проверка в getImportMeta()
**Место**: `csv-import.service.ts`, метод `getImportMeta()`
**Проверка**: После получения метаданных, перед возвратом
**Действие**: Если `systemFields = []` или `undefined` → фатальная ошибка

### 5.2. Проверка в importDeals() (опционально)
**Место**: `csv-import.service.ts`, метод `importDeals()`, начало метода
**Проверка**: Валидация mapping против доступных полей
**Действие**: Если mapping содержит поля, которых нет в systemFields → предупреждение или ошибка

### 5.3. Рекомендация
**Приоритет**: Высокий
**Действие**: Добавить проверку в `getImportMeta()` - это предотвратит silent fail на уровне UX



