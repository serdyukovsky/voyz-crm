# Stage 5: COUNT, Aggregations, Summary

## –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö count() –∑–∞–ø—Ä–æ—Å–æ–≤

### üî¥ –ö–†–ò–¢–ò–ß–ù–û: stats.service.ts:getGlobalStats()

**–ü—Ä–æ–±–ª–µ–º–∞ 1: `totalDeals = await this.prisma.deal.count()`**
- **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `stats.service.ts:10`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª–Ω—ã–π count –≤—Å–µ—Ö deals –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ - O(n) –æ–ø–µ—Ä–∞—Ü–∏—è
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫
- **–ß–∞—Å—Ç–æ—Ç–∞:** –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (auto-refresh –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ)
- **–†–µ—à–µ–Ω–∏–µ:** 
  - –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `groupBy` –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (sum –≤—Å–µ—Ö counts)
  - –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π count —á–µ—Ä–µ–∑ `pg_class.reltuples` (–±—ã—Å—Ç—Ä–æ, –Ω–æ –Ω–µ—Ç–æ—á–Ω–æ)
  - –í–∞—Ä–∏–∞–Ω—Ç 3: –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 1-5 –º–∏–Ω—É—Ç (stats –Ω–µ –Ω—É–∂–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)

**–ü—Ä–æ–±–ª–µ–º–∞ 2: `closedDeals.findMany()` –¥–ª—è totalRevenue**
- **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `stats.service.ts:40-54`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∑–∞–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–º–º—ã amount
- **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `aggregate({ _sum: { amount: true } })` –≤–º–µ—Å—Ç–æ findMany + reduce

**–ü—Ä–æ–±–ª–µ–º–∞ 3: `closedDealsForTrend.findMany()`**
- **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `stats.service.ts:174-189`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∑–∞–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏ –∑–∞ 7 –¥–Ω–µ–π –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ
- **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `groupBy` –ø–æ –¥–∞—Ç–µ —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π —Å—É–º–º—ã

### üü° –í–ê–ñ–ù–û: contacts.service.ts:findAll()

**–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ count()**
- **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `contacts.service.ts:170-175`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í—ã–ø–æ–ª–Ω—è–µ—Ç `count()` –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –∫–æ–¥ –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç where —É—Å–ª–æ–≤–∏–µ
- **–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–π count() - –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

### üü° –°–†–ï–î–ù–ò–ô: analytics.service.ts

**–ü—Ä–æ–±–ª–µ–º–∞: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ count() –∑–∞–ø—Ä–æ—Å—ã**
- **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `analytics.service.ts:20-25`
- **–ü—Ä–æ–±–ª–µ–º–∞:** 4 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö count() –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ—Ö–æ–∂–∏–º–∏ where —É—Å–ª–æ–≤–∏—è–º–∏
- **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω `groupBy` –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π (won, lost, inProgress)
- **–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ:** `getMessageMetrics`, `getCallMetrics` - –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

### ‚úÖ –£–ñ–ï –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û

1. **Contact/Company Stats** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç batch loading —á–µ—Ä–µ–∑ `getContactStatsBatch`, `getCompanyStatsBatch`
2. **Deal Stats –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç `findMany` —Å select —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –ø–æ–ª–µ–π, –∑–∞—Ç–µ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ –ø–∞–º—è—Ç–∏

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±—ã—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç):

1. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å totalRevenue –≤ getGlobalStats()**
   - **–ë—ã–ª–æ:** `findMany()` + `reduce()` 
   - **–°—Ç–∞–ª–æ:** `aggregate({ _sum: { amount: true } })`
   - **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 10-100x (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—É–º–º–∞, –∞ –Ω–µ –≤—Å–µ –∑–∞–ø–∏—Å–∏)
   - **–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π
   - **Rollback:** –í–µ—Ä–Ω—É—Ç—å findMany

2. **–£–¥–∞–ª–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–π count() –≤ contacts.service.ts**
   - **–ë—ã–ª–æ:** –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è count() –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   - **–°—Ç–∞–ª–æ:** –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 170-175
   - **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** –£–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å
   - **–†–∏—Å–∫:** –ù—É–ª–µ–≤–æ–π (–∫–æ–¥ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π)

3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å revenueTrend —á–µ—Ä–µ–∑ groupBy**
   - **–ë—ã–ª–æ:** `findMany()` –≤—Å–µ—Ö –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫ –∑–∞ 7 –¥–Ω–µ–π + –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ –ø–∞–º—è—Ç–∏
   - **–°—Ç–∞–ª–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL GROUP BY —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π —Å—É–º–º—ã
   - **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 5-10x (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î)
   - **–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π (–Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å raw SQL –∏–ª–∏ –Ω–∞–π—Ç–∏ —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ Prisma)

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å totalDeals —á–µ—Ä–µ–∑ groupBy**
   - **–ë—ã–ª–æ:** –û—Ç–¥–µ–ª—å–Ω—ã–π `count()` –∑–∞–ø—Ä–æ—Å
   - **–°—Ç–∞–ª–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É–º–º—É –∏–∑ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ–º–æ–≥–æ `groupBy` –ø–æ stageId
   - **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** –£–±–∏—Ä–∞–µ—Ç 1 –∑–∞–ø—Ä–æ—Å
   - **–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π

5. **–û–±—ä–µ–¥–∏–Ω–∏—Ç—å count() –≤ analytics.service.ts**
   - **–ë—ã–ª–æ:** 4 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö count() –∑–∞–ø—Ä–æ—Å–∞
   - **–°—Ç–∞–ª–æ:** 1 groupBy –∑–∞–ø—Ä–æ—Å —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ stage.isClosed –∏ stage.name
   - **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 3x (–º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤)
   - **–†–∏—Å–∫:** –°—Ä–µ–¥–Ω–∏–π (–Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å)

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç / –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:

6. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ getGlobalStats()**
   - **–†–µ—à–µ–Ω–∏–µ:** –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 1-5 –º–∏–Ω—É—Ç (stats –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
   - **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 100x –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - **–†–∏—Å–∫:** –°—Ä–µ–¥–Ω–∏–π (–Ω—É–∂–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö)
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –¥—Ä—É–≥–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

7. **–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π count –¥–ª—è totalDeals**
   - **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pg_class.reltuples` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–≥–æ count
   - **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 100-1000x (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç scan —Ç–∞–±–ª–∏—Ü—ã)
   - **–†–∏—Å–∫:** –í—ã—Å–æ–∫–∏–π (–Ω–µ—Ç–æ—á–Ω–æ—Å—Ç—å, –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º)
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è totalRevenue

```typescript
// –ë—ã–ª–æ:
const closedDeals = await this.prisma.deal.findMany({
  where: { stage: { isClosed: true } },
  select: { amount: true },
});
const totalRevenue = closedDeals.reduce((sum, deal) => sum + Number(deal.amount), 0);

// –°—Ç–∞–ª–æ:
const totalRevenueResult = await this.prisma.deal.aggregate({
  where: { stage: { isClosed: true } },
  _sum: { amount: true },
});
const totalRevenue = Number(totalRevenueResult._sum.amount || 0);
```

### 2. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω–æ–≥–æ count()

```typescript
// –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 170-175 –≤ contacts.service.ts
// –í–µ—Å—å –±–ª–æ–∫ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å - count –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ groupBy –¥–ª—è revenueTrend

–ò—Å–ø–æ–ª—å–∑—É—è Prisma raw SQL (—Ç–∞–∫ –∫–∞–∫ Prisma –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç DATE_TRUNC –Ω–∞–ø—Ä—è–º—É—é):

```typescript
const revenueTrendRaw = await this.prisma.$queryRaw`
  SELECT 
    DATE(COALESCE("closedAt", "updatedAt")) as date,
    SUM("amount")::numeric as revenue
  FROM "deals"
  WHERE "stageId" IN (SELECT id FROM "stages" WHERE "isClosed" = true)
    AND (COALESCE("closedAt", "updatedAt") >= NOW() - INTERVAL '7 days')
  GROUP BY DATE(COALESCE("closedAt", "updatedAt"))
  ORDER BY date
`;
```

–ò–ª–∏ —á–µ—Ä–µ–∑ findMany —Å –º–µ–Ω—å—à–∏–º –Ω–∞–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –≤ –ø–∞–º—è—Ç–∏ (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å).

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è totalDeals

```typescript
// –ë—ã–ª–æ:
const totalDeals = await this.prisma.deal.count();
const dealsByStageData = await this.prisma.deal.groupBy({ ... });

// –°—Ç–∞–ª–æ:
const dealsByStageData = await this.prisma.deal.groupBy({ ... });
const totalDeals = dealsByStageData.reduce((sum, stage) => sum + stage._count.id, 0);
```

## –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç

- **totalRevenue:** 10-100x –±—ã—Å—Ç—Ä–µ–µ (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏)
- **revenueTrend:** 5-10x –±—ã—Å—Ç—Ä–µ–µ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ë–î)
- **totalDeals:** –£–±–∏—Ä–∞–µ—Ç 1 –∑–∞–ø—Ä–æ—Å
- **contacts.findAll:** –£–±–∏—Ä–∞–µ—Ç 1 –Ω–µ–Ω—É–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å
- **analytics:** 3x –±—ã—Å—Ç—Ä–µ–µ (–º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤)

**–û–±—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è dashboard:**
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: **5-10x –±—ã—Å—Ç—Ä–µ–µ**
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î: **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 50-70%**


