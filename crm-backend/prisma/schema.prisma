generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(uuid())
  email                  String                  @unique
  password               String
  firstName              String
  lastName               String
  avatar                 String?
  role                   UserRole                @default(MANAGER)
  isActive               Boolean                 @default(true)
  lastLoginAt            DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  phone                  String?
  telegramUsername       String?
  activities             Activity[]
  calls                  Call[]
  chatThreadParticipants ChatThreadParticipant[]
  comments               Comment[]
  assignedDeals          Deal[]                  @relation("DealAssignee")
  deals                  Deal[]                  @relation("DealCreator")
  exportJobs             ExportJob[]
  files                  File[]                  @relation("FileUploader")
  importJobs             ImportJob[]
  messages               Message[]
  refreshTokens          RefreshToken[]
  assignedTasks          Task[]                  @relation("TaskAssignee")
  tasks                  Task[]                  @relation("TaskCreator")
  permissions            UserPermission[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model UserPermission {
  id         String   @id @default(uuid())
  userId     String
  permission String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@index([userId])
  @@map("user_permissions")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([userId, expiresAt])
  @@map("refresh_tokens")
}

model Pipeline {
  id          String   @id @default(uuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deals       Deal[]
  stages      Stage[]

  @@index([isDefault])
  @@map("pipelines")
}

model Stage {
  id         String         @id @default(uuid())
  pipelineId String
  name       String
  order      Int
  color      String         @default("#6B7280")
  isDefault  Boolean        @default(false)
  isClosed   Boolean        @default(false)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  deals      Deal[]
  triggers   StageTrigger[]
  pipeline   Pipeline       @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@unique([pipelineId, order])
  @@index([pipelineId])
  @@map("stages")
}

model StageTrigger {
  id          String   @id @default(uuid())
  stageId     String
  triggerType String
  actionType  String
  actionData  Json?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  stage       Stage    @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([stageId])
  @@map("stage_triggers")
}

model Contact {
  id                 String             @id @default(uuid())
  fullName           String
  email              String?            @unique
  phone              String?            @unique
  position           String?
  companyName        String?
  companyId          String?
  tags               String[]           @default([])
  notes              String?
  social             Json?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  contactInfo        String?
  contactMethods     String[]           @default([])
  directions         String[]           @default([])
  link               String?
  subscriberCount    String?
  websiteOrTgChannel String?
  activities         Activity[]
  comments           Comment[]
  company            Company?           @relation(fields: [companyId], references: [id])
  customFieldValues  CustomFieldValue[]
  deals              Deal[]
  files              File[]
  tasks              Task[]

  @@index([email])
  @@index([phone])
  @@index([companyName])
  @@index([companyId])
  @@index([createdAt])
  @@index([fullName])
  @@index([email, phone])
  @@index([fullName(ops: raw("gin_trgm_ops"))], map: "contacts_fullname_gin_idx", type: Gin)
  @@index([tags], map: "contacts_tags_gin_idx", type: Gin)
  @@map("contacts")
}

model Company {
  id        String    @id @default(uuid())
  name      String    @unique
  website   String?
  industry  String?
  email     String?   @unique
  phone     String?
  social    Json?
  address   String?
  notes     String?
  employees Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  contacts  Contact[]
  deals     Deal[]

  @@index([name])
  @@index([industry])
  @@index([email])
  @@index([createdAt])
  @@index([phone])
  @@map("companies")
}

model Deal {
  id                String             @id @default(uuid())
  number            String             @unique
  title             String
  amount            Decimal            @default(0) @db.Decimal(12, 2)
  budget            Decimal?           @db.Decimal(12, 2)
  pipelineId        String
  stageId           String
  assignedToId      String?
  createdById       String
  contactId         String?
  companyId         String?
  expectedCloseAt   DateTime?
  closedAt          DateTime?
  description       String?
  tags              String[]           @default([])
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  rejectionReasons  String[]           @default([])
  activities        Activity[]
  calls             Call[]
  chatThreads       ChatThread[]
  comments          Comment[]
  customFieldValues CustomFieldValue[]
  assignedTo        User?              @relation("DealAssignee", fields: [assignedToId], references: [id])
  company           Company?           @relation(fields: [companyId], references: [id])
  contact           Contact?           @relation(fields: [contactId], references: [id])
  createdBy         User               @relation("DealCreator", fields: [createdById], references: [id])
  pipeline          Pipeline           @relation(fields: [pipelineId], references: [id])
  stage             Stage              @relation(fields: [stageId], references: [id])
  files             File[]
  messages          Message[]
  tasks             Task[]

  @@index([pipelineId])
  @@index([stageId])
  @@index([pipelineId, stageId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([contactId])
  @@index([companyId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([tags], map: "deals_tags_gin_idx", type: Gin)
  @@index([title(ops: raw("gin_trgm_ops"))], map: "deals_title_gin_idx", type: Gin)
  @@map("deals")
}

model CustomField {
  id           String             @id @default(uuid())
  name         String
  key          String             @unique
  type         CustomFieldType
  entityType   String
  group        String?
  order        Int                @default(0)
  isRequired   Boolean            @default(false)
  isUnique     Boolean            @default(false)
  defaultValue Json?
  options      Json?
  description  String?
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  values       CustomFieldValue[]

  @@unique([key, entityType])
  @@index([entityType, isActive])
  @@map("custom_fields")
}

model CustomFieldValue {
  id            String      @id @default(uuid())
  customFieldId String
  dealId        String?
  contactId     String?
  entityId      String?
  entityType    String?
  value         Json
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  contact       Contact?    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  deal          Deal?       @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([customFieldId, dealId])
  @@unique([customFieldId, contactId])
  @@index([customFieldId])
  @@index([dealId])
  @@index([contactId])
  @@index([entityType, entityId])
  @@map("custom_field_values")
}

model Task {
  id           String       @id @default(uuid())
  dealId       String?
  contactId    String?
  title        String
  description  String?
  status       TaskStatus   @default(TODO)
  priority     TaskPriority @default(MEDIUM)
  type         TaskType?    @default(OTHER)
  deadline     DateTime?
  completedAt  DateTime?
  result       String?
  createdById  String
  assignedToId String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  activities   Activity[]
  chatThreads  ChatThread[]
  comments     Comment[]
  files        File[]
  assignedTo   User         @relation("TaskAssignee", fields: [assignedToId], references: [id])
  contact      Contact?     @relation(fields: [contactId], references: [id])
  createdBy    User         @relation("TaskCreator", fields: [createdById], references: [id])
  deal         Deal?        @relation(fields: [dealId], references: [id])

  @@index([dealId])
  @@index([contactId])
  @@index([assignedToId])
  @@index([status])
  @@index([deadline])
  @@index([type])
  @@index([createdAt])
  @@index([createdById])
  @@map("tasks")
}

model Comment {
  id        String      @id @default(uuid())
  dealId    String?
  taskId    String?
  contactId String?
  userId    String
  type      CommentType @default(COMMENT)
  content   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  contact   Contact?    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal      Deal?       @relation(fields: [dealId], references: [id], onDelete: Cascade)
  task      Task?       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id])
  files     File[]

  @@index([dealId])
  @@index([taskId])
  @@index([contactId])
  @@index([userId])
  @@index([type])
  @@map("comments")
}

model Activity {
  id        String       @id @default(uuid())
  type      ActivityType
  dealId    String?
  taskId    String?
  contactId String?
  userId    String
  payload   Json?
  createdAt DateTime     @default(now())
  contact   Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal      Deal?        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  task      Task?        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id])

  @@index([dealId])
  @@index([dealId, createdAt])
  @@index([taskId])
  @@index([contactId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activities")
}

model File {
  id           String   @id @default(uuid())
  dealId       String?
  taskId       String?
  contactId    String?
  commentId    String?
  fileName     String
  originalName String
  mime         String
  size         Int
  entityType   String
  entityId     String?
  url          String
  thumbnailUrl String?
  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  comment      Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  contact      Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal         Deal?    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  task         Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation("FileUploader", fields: [uploadedById], references: [id])

  @@index([dealId])
  @@index([taskId])
  @@index([contactId])
  @@index([commentId])
  @@index([entityType, entityId])
  @@index([uploadedById])
  @@map("files")
}

model Message {
  id                String           @id @default(uuid())
  dealId            String?
  externalMessageId String
  integrationType   IntegrationType
  direction         MessageDirection
  sender            String
  recipient         String
  content           String
  attachments       Json?
  metadata          Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  userId            String?
  threadId          String?
  deal              Deal?            @relation(fields: [dealId], references: [id])
  thread            ChatThread?      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user              User?            @relation(fields: [userId], references: [id])

  @@index([dealId])
  @@index([externalMessageId, integrationType])
  @@index([integrationType, direction])
  @@index([createdAt])
  @@map("messages")
}

model Call {
  id             String        @id @default(uuid())
  dealId         String?
  userId         String?
  externalCallId String?
  phone          String
  direction      CallDirection
  duration       Int?
  recordingUrl   String?
  status         String?
  metadata       Json?
  createdAt      DateTime      @default(now())
  deal           Deal?         @relation(fields: [dealId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])

  @@index([dealId])
  @@index([phone])
  @@index([createdAt])
  @@map("calls")
}

model IntegrationSettings {
  id          String          @id @default(uuid())
  type        IntegrationType @unique
  credentials Json
  enabled     Boolean         @default(false)
  config      Json?
  webhookUrl  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("integration_settings")
}

model ImportJob {
  id            String   @id @default(uuid())
  fileName      String
  fileType      String
  entityType    String
  status        String
  progress      Int      @default(0)
  totalRows     Int?
  processedRows Int      @default(0)
  errors        Json?
  mapping       Json?
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     User     @relation(fields: [createdById], references: [id])

  @@index([status])
  @@index([entityType])
  @@index([createdById])
  @@map("import_jobs")
}

model ExportJob {
  id          String   @id @default(uuid())
  fileType    String
  entityType  String
  status      String
  filters     Json?
  fields      Json?
  fileUrl     String?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([status])
  @@index([entityType])
  @@index([createdById])
  @@map("export_jobs")
}

model SystemFieldOptions {
  id         String   @id @default(uuid())
  entityType String
  fieldName  String
  options    String[] @default([])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([entityType, fieldName])
  @@index([entityType, fieldName])
  @@map("system_field_options")
}

model Log {
  id        String   @id @default(uuid())
  level     String
  action    String
  entity    String?
  entityId  String?
  userId    String?
  message   String
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([action])
  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("logs")
}

model ChatThread {
  id           String                  @id @default(uuid())
  dealId       String?
  taskId       String?
  title        String?
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  participants ChatThreadParticipant[]
  deal         Deal?                   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  task         Task?                   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  messages     Message[]

  @@index([dealId])
  @@index([taskId])
  @@map("chat_threads")
}

model ChatThreadParticipant {
  id        String     @id @default(uuid())
  threadId  String
  userId    String
  createdAt DateTime   @default(now())
  thread    ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@index([threadId])
  @@index([userId])
  @@map("chat_thread_participants")
}

enum UserRole {
  ADMIN
  MANAGER
  VIEWER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  OVERDUE
}

enum TaskType {
  CALL
  MEETING
  FOLLOW_UP
  EMAIL
  OTHER
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum CustomFieldType {
  TEXT
  NUMBER
  SELECT
  MULTI_SELECT
  DATE
  BOOLEAN
  RELATION
}

enum ActivityType {
  DEAL_CREATED
  DEAL_UPDATED
  DEAL_DELETED
  FIELD_UPDATED
  STAGE_CHANGED
  CONTACT_LINKED
  CONTACT_UNLINKED
  CONTACT_UPDATED_IN_DEAL
  TASK_CREATED
  TASK_UPDATED
  TASK_COMPLETED
  TASK_DELETED
  COMMENT_ADDED
  FILE_UPLOADED
  FILE_DELETED
  ASSIGNEE_CHANGED
  TAG_ADDED
  TAG_REMOVED
  CONTACT_CREATED
  CONTACT_UPDATED
  CONTACT_DELETED
  COMPANY_CREATED
  COMPANY_UPDATED
  COMPANY_DELETED
  EMAIL_SENT
  LOGIN
  LOGOUT
}

enum CommentType {
  COMMENT
  INTERNAL_NOTE
  CLIENT_MESSAGE
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum IntegrationType {
  WHATSAPP
  TELEGRAM
  VK
  EMAIL
  TELEPHONY
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum FileType {
  IMAGE
  DOCUMENT
  SPREADSHEET
  PDF
  OTHER
}
