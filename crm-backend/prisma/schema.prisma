// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MANAGER
  VIEWER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  OVERDUE
}

enum TaskType {
  CALL
  MEETING
  FOLLOW_UP
  EMAIL
  OTHER
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum CustomFieldType {
  TEXT
  NUMBER
  SELECT
  MULTI_SELECT
  DATE
  BOOLEAN
  RELATION
}

enum ActivityType {
  DEAL_CREATED
  DEAL_UPDATED
  DEAL_DELETED
  FIELD_UPDATED
  STAGE_CHANGED
  CONTACT_LINKED
  CONTACT_UNLINKED
  CONTACT_UPDATED_IN_DEAL
  TASK_CREATED
  TASK_UPDATED
  TASK_COMPLETED
  TASK_DELETED
  COMMENT_ADDED
  FILE_UPLOADED
  FILE_DELETED
  ASSIGNEE_CHANGED
  TAG_ADDED
  TAG_REMOVED
  CONTACT_CREATED
  CONTACT_UPDATED
  CONTACT_DELETED
  COMPANY_CREATED
  COMPANY_UPDATED
  COMPANY_DELETED
  EMAIL_SENT
  LOGIN
  LOGOUT
}

enum CommentType {
  COMMENT
  INTERNAL_NOTE
  CLIENT_MESSAGE
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum IntegrationType {
  WHATSAPP
  TELEGRAM
  VK
  EMAIL
  TELEPHONY
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum FileType {
  IMAGE
  DOCUMENT
  SPREADSHEET
  PDF
  OTHER
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  avatar        String?
  role          UserRole @default(MANAGER)
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  deals         Deal[]            @relation("DealCreator")
  assignedDeals Deal[]            @relation("DealAssignee")
  tasks         Task[]            @relation("TaskCreator")
  assignedTasks Task[]            @relation("TaskAssignee")
  comments      Comment[]
  activities    Activity[]
  messages      Message[]
  calls         Call[]
  permissions   UserPermission[]
  refreshTokens RefreshToken[]
  files         File[]            @relation("FileUploader")
  importJobs    ImportJob[]
  exportJobs    ExportJob[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model UserPermission {
  id        String   @id @default(uuid())
  userId    String
  permission String  // e.g., "deals.delete", "fields.manage"
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@index([userId])
  @@map("user_permissions")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([userId, expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// PIPELINES & STAGES
// ============================================

model Pipeline {
  id          String   @id @default(uuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  stages      Stage[]
  deals       Deal[]

  @@index([isDefault])
  @@map("pipelines")
}

model Stage {
  id          String   @id @default(uuid())
  pipelineId  String
  name        String
  order       Int
  color       String   @default("#6B7280")
  isDefault   Boolean  @default(false)
  isClosed    Boolean  @default(false) // For closed-won/lost stages
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  deals       Deal[]
  triggers    StageTrigger[]

  @@unique([pipelineId, order])
  @@index([pipelineId])
  @@map("stages")
}

model StageTrigger {
  id          String   @id @default(uuid())
  stageId     String
  triggerType String   // "on_enter", "on_exit", "on_create"
  actionType  String   // "create_task", "send_email", "webhook", etc.
  actionData  Json?    // Action-specific configuration
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stage       Stage    @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([stageId])
  @@map("stage_triggers")
}

// ============================================
// CONTACTS
// ============================================

model Contact {
  id        String   @id @default(uuid())
  fullName  String
  email     String?
  phone     String?
  position  String?
  companyName String? // For now, later can be linked to Company
  companyId String?
  tags      String[] @default([])
  notes     String?
  social    Json?    // { instagram, telegram, whatsapp, vk }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  deals     Deal[]
  tasks     Task[]
  comments  Comment[]
  activities Activity[]
  files     File[]
  customFieldValues CustomFieldValue[]

  @@index([email])
  @@index([phone])
  @@index([companyName])
  @@index([companyId])
  @@index([createdAt])
  @@index([fullName])
  @@index([email, phone]) // Composite index for search
  @@map("contacts")
}

model Company {
  id        String   @id @default(uuid())
  name      String
  website   String?
  industry  String?
  email     String?
  phone     String?
  social    Json?    // { instagram, telegram, whatsapp, vk, linkedin }
  address   String?
  notes     String?
  employees Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contacts  Contact[]
  deals     Deal[]

  @@index([name])
  @@index([industry])
  @@index([email])
  @@index([createdAt])
  @@map("companies")
}

// ============================================
// DEALS
// ============================================

model Deal {
  id              String    @id @default(uuid())
  number          String    @unique
  title           String
  amount          Decimal   @default(0) @db.Decimal(12, 2)
  budget          Decimal?  @db.Decimal(12, 2)
  pipelineId      String
  stageId         String
  assignedToId    String?
  createdById     String
  contactId       String?
  companyId       String?
  expectedCloseAt DateTime?
  closedAt        DateTime?
  description     String?
  tags            String[]  @default([])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  pipeline        Pipeline  @relation(fields: [pipelineId], references: [id])
  stage           Stage     @relation(fields: [stageId], references: [id])
  createdBy       User      @relation("DealCreator", fields: [createdById], references: [id])
  assignedTo      User?     @relation("DealAssignee", fields: [assignedToId], references: [id])
  contact         Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  company         Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  tasks           Task[]
  comments        Comment[]
  activities      Activity[]
  files           File[]
  customFieldValues CustomFieldValue[]
  messages        Message[]
  calls           Call[]

  @@index([pipelineId])
  @@index([stageId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([contactId])
  @@index([createdAt])
  @@map("deals")
}

// ============================================
// CUSTOM FIELDS
// ============================================

model CustomField {
  id          String          @id @default(uuid())
  name        String
  key         String          @unique // Unique identifier for the field
  type        CustomFieldType
  entityType  String          // "deal", "contact", "company"
  group       String?         // For grouping fields
  order       Int             @default(0)
  isRequired  Boolean         @default(false)
  isUnique    Boolean         @default(false)
  defaultValue Json?          // Default value based on type
  options     Json?           // For select/multi-select: array of options
  description String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  values      CustomFieldValue[]

  @@unique([key, entityType])
  @@index([entityType, isActive])
  @@map("custom_fields")
}

model CustomFieldValue {
  id            String       @id @default(uuid())
  customFieldId String
  dealId        String?
  contactId     String?
  entityId      String?      // Generic entity ID for future extensions
  entityType    String?      // "deal", "contact"
  value         Json         // Flexible value storage
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  customField   CustomField  @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  deal          Deal?        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact       Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([customFieldId, dealId])
  @@unique([customFieldId, contactId])
  @@index([customFieldId])
  @@index([dealId])
  @@index([contactId])
  @@index([entityType, entityId])
  @@map("custom_field_values")
}

// ============================================
// TASKS
// ============================================

model Task {
  id          String       @id @default(uuid())
  dealId      String?
  contactId   String?
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  type        TaskType?    @default(OTHER)
  deadline    DateTime?    // Renamed from dueDate
  completedAt DateTime?
  result      String?      // Task result/outcome
  createdById String
  assignedToId String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  deal        Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)
  contact     Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)
  createdBy   User         @relation("TaskCreator", fields: [createdById], references: [id])
  assignedTo User          @relation("TaskAssignee", fields: [assignedToId], references: [id])
  activities  Activity[]
  comments    Comment[]
  files       File[]

  @@index([dealId])
  @@index([contactId])
  @@index([assignedToId])
  @@index([status])
  @@index([deadline])
  @@index([type])
  @@map("tasks")
}

// ============================================
// COMMENTS
// ============================================

model Comment {
  id        String      @id @default(uuid())
  dealId    String?
  taskId    String?
  contactId String?
  userId    String
  type      CommentType @default(COMMENT)
  content   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  deal      Deal?       @relation(fields: [dealId], references: [id], onDelete: Cascade)
  task      Task?       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  contact   Contact?    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id])
  files     File[]

  @@index([dealId])
  @@index([taskId])
  @@index([contactId])
  @@index([userId])
  @@index([type])
  @@map("comments")
}

// ============================================
// ACTIVITY LOG
// ============================================

model Activity {
  id        String       @id @default(uuid())
  type      ActivityType
  dealId    String?
  taskId    String?
  contactId String?
  userId    String
  payload   Json?        // Flexible metadata for different activity types
  createdAt DateTime     @default(now())

  // Relations
  deal      Deal?        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  task      Task?        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  contact   Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id])

  @@index([dealId])
  @@index([taskId])
  @@index([contactId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activities")
}

// ============================================
// FILES
// ============================================

model File {
  id          String   @id @default(uuid())
  dealId      String?
  taskId      String?
  contactId   String?
  commentId   String?
  fileName    String
  originalName String
  mime        String   // Renamed from mimeType
  size        Int      // Size in bytes
  entityType  String   // "deal", "task", "contact", "comment"
  entityId    String?  // Generic entity ID
  url         String   // Storage URL or path
  thumbnailUrl String? // For images
  uploadedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  deal        Deal?    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  comment     Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  uploadedBy  User     @relation("FileUploader", fields: [uploadedById], references: [id])

  @@index([dealId])
  @@index([taskId])
  @@index([contactId])
  @@index([commentId])
  @@index([entityType, entityId])
  @@index([uploadedById])
  @@map("files")
}

// ============================================
// INTEGRATIONS
// ============================================

model Message {
  id                String           @id @default(uuid())
  dealId            String?
  externalMessageId String           // ID from external system
  integrationType   IntegrationType
  direction         MessageDirection
  sender            String           // Phone, email, username, etc.
  recipient         String           // Phone, email, username, etc.
  content           String
  attachments       Json?            // Array of attachment objects
  metadata          Json?            // Additional integration-specific data
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  deal              Deal?            @relation(fields: [dealId], references: [id], onDelete: SetNull)
  userId            String?
  user              User?            @relation(fields: [userId], references: [id])

  @@index([dealId])
  @@index([externalMessageId, integrationType])
  @@index([integrationType, direction])
  @@index([createdAt])
  @@map("messages")
}

model Call {
  id            String         @id @default(uuid())
  dealId        String?
  userId        String?
  externalCallId String?       // ID from telephony system
  phone         String
  direction     CallDirection
  duration      Int?           // Duration in seconds
  recordingUrl  String?
  status        String?        // answered, missed, busy, etc.
  metadata      Json?          // Additional call data
  createdAt     DateTime       @default(now())

  // Relations
  deal          Deal?          @relation(fields: [dealId], references: [id], onDelete: SetNull)
  user          User?          @relation(fields: [userId], references: [id])

  @@index([dealId])
  @@index([phone])
  @@index([createdAt])
  @@map("calls")
}

model IntegrationSettings {
  id          String           @id @default(uuid())
  type        IntegrationType  @unique
  credentials Json             // Encrypted credentials
  enabled     Boolean          @default(false)
  config      Json?            // Additional configuration
  webhookUrl  String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("integration_settings")
}

// ============================================
// IMPORT/EXPORT
// ============================================

model ImportJob {
  id          String   @id @default(uuid())
  fileName    String
  fileType    String   // "csv", "xlsx"
  entityType  String   // "contact", "deal", "task"
  status      String   // "pending", "processing", "completed", "failed"
  progress    Int      @default(0)
  totalRows   Int?
  processedRows Int    @default(0)
  errors      Json?    // Array of errors
  mapping     Json?    // Column mapping
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([status])
  @@index([entityType])
  @@index([createdById])
  @@map("import_jobs")
}

model ExportJob {
  id          String   @id @default(uuid())
  fileType    String   // "csv", "xlsx"
  entityType  String   // "deal", "contact", "task"
  status      String   // "pending", "processing", "completed", "failed"
  filters     Json?    // Export filters
  fields      Json?    // Selected fields
  fileUrl     String?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([status])
  @@index([entityType])
  @@index([createdById])
  @@map("export_jobs")
}

// ============================================
// LOGS
// ============================================

model Log {
  id        String   @id @default(uuid())
  level     String   // "info", "warn", "error"
  action    String   // "create", "update", "delete", "login", etc.
  entity    String?  // "deal", "task", "user", etc.
  entityId  String?
  userId    String?
  message   String
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([action])
  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("logs")
}
