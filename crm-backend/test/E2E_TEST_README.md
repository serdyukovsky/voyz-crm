# E2E Tests - Import API

## Структура тестов

### test/import.e2e-spec.ts

E2E тесты для Import API endpoints:
- `POST /api/import/contacts`
- `POST /api/import/deals`

---

## Покрытие тестами

### POST /api/import/contacts - 7 тестов

1. ✅ **200 OK при валидном CSV**
   - Проверка: статус 200
   - Проверка: структура ответа (summary, errors)
   - Проверка: корректные значения

2. ✅ **Корректный importResult**
   - Проверка: все поля summary присутствуют
   - Проверка: типы полей (number)
   - Проверка: значения корректны
   - Проверка: данные сохранены в БД

3. ✅ **400 при неверном mapping**
   - Проверка: отсутствует обязательное поле fullName
   - Проверка: сообщение об ошибке содержит поле

4. ✅ **400 при невалидном JSON mapping**
   - Проверка: невалидный JSON
   - Проверка: сообщение об ошибке

5. ✅ **400 при отсутствии файла**
   - Проверка: файл не передан
   - Проверка: сообщение об ошибке

6. ✅ **413 при большом файле**
   - Проверка: файл > 10MB
   - Проверка: статус 413 Payload Too Large
   - Проверка: сообщение об ошибке

7. ✅ **CSV с разделителем ;**
   - Проверка: разделитель `;` обрабатывается
   - Проверка: данные корректно импортируются

---

### POST /api/import/deals - 5 тестов

1. ✅ **200 OK при валидном CSV**
   - Проверка: статус 200
   - Проверка: структура ответа

2. ✅ **Корректный importResult для сделок**
   - Проверка: все поля присутствуют
   - Проверка: типы полей
   - Проверка: данные сохранены в БД

3. ✅ **400 при неверном mapping для сделок**
   - Проверка: отсутствует обязательное поле number
   - Проверка: сообщение об ошибке

4. ✅ **400 при отсутствии обязательных полей в mapping**
   - Проверка: отсутствует pipelineId
   - Проверка: сообщение об ошибке

5. ✅ **413 при большом файле для сделок**
   - Проверка: файл > 10MB
   - Проверка: статус 413

---

### Authentication - 2 теста

1. ✅ **401 при отсутствии токена**
   - Проверка: запрос без токена
   - Проверка: статус 401

2. ✅ **401 при невалидном токене**
   - Проверка: запрос с невалидным токеном
   - Проверка: статус 401

---

## Запуск тестов

```bash
# Все e2e тесты
npm run test:e2e

# Только import тесты
npm run test:e2e -- import.e2e-spec.ts

# С verbose выводом
npm run test:e2e -- --verbose
```

---

## Настройка

### Требования

- Тестовая БД настроена
- Миграции применены
- Переменные окружения настроены

### Конфигурация

Файл `test/jest-e2e.json`:
- Использует ts-jest для трансформации
- Поддерживает path aliases (`@/`)
- Тестовая среда: node

---

## Особенности

- ✅ **Реальная БД** - используется реальная Prisma БД
- ✅ **Аутентификация** - создается тестовый пользователь и токен
- ✅ **Очистка БД** - перед каждым тестом
- ✅ **Multipart/form-data** - загрузка файлов через supertest
- ✅ **Валидация** - проверка всех статусов и структур ответов

---

## Структура тестового окружения

```
beforeAll:
  - Создание тестового пользователя
  - Получение auth токена
  - Создание тестового pipeline и stage

beforeEach:
  - Очистка БД (contacts, deals, companies, activities)

afterAll:
  - Полная очистка БД
  - Закрытие приложения
```

---

## Примеры использования

### Валидный запрос

```typescript
const response = await request(app.getHttpServer())
  .post('/api/import/contacts')
  .set('Authorization', `Bearer ${authToken}`)
  .attach('file', Buffer.from(csvContent), 'contacts.csv')
  .field('mapping', JSON.stringify(mapping))
  .expect(200);
```

### С разделителем ;

```typescript
const response = await request(app.getHttpServer())
  .post('/api/import/contacts')
  .set('Authorization', `Bearer ${authToken}`)
  .attach('file', Buffer.from(csvContent), 'contacts.csv')
  .field('mapping', JSON.stringify(mapping))
  .field('delimiter', ';')
  .expect(200);
```

---

## Итого

- **Всего e2e тестов**: 14
- **Покрытие**: Все основные сценарии API
- **Тип тестов**: E2E (end-to-end)
- **Инструменты**: supertest, NestJS TestingModule

