# Test Summary - CSV Import Tests

## Покрытие тестами

### csv-import.service.spec.ts

#### importContacts() - 8 тестов

1. ✅ **Импорт 3 новых контактов**
   - Проверка: созданы все 3 контакта
   - Проверка: поля заполнены корректно
   - Проверка: summary.created = 3

2. ✅ **Update существующего по email**
   - Проверка: summary.updated = 1
   - Проверка: поля обновлены в БД
   - Проверка: email не изменился

3. ✅ **Поиск по phone если нет email**
   - Проверка: найден контакт по phone
   - Проверка: обновлен существующий

4. ✅ **Пропуск строки с пустым именем**
   - Проверка: summary.failed = 1
   - Проверка: ошибка содержит номер строки и поле
   - Проверка: создан только валидный контакт

5. ✅ **Нормализация email / phone**
   - Проверка: email в lowercase
   - Проверка: phone в E.164 format
   - Проверка: созданы 2 контакта

6. ✅ **Корректный importResult**
   - Проверка: created, updated, failed корректны
   - Проверка: ошибки содержат детали

7. ✅ **Обработка tags**
   - Проверка: tags парсятся из CSV
   - Проверка: сохранены в БД

8. ✅ **Обработка social links**
   - Проверка: social links нормализуются
   - Проверка: сохранены в БД

#### importDeals() - 7 тестов

1. ✅ **Импорт сделки с существующим contact (email)**
   - Проверка: contactId резолвится по email
   - Проверка: сделка создана с правильным contactId

2. ✅ **Обработка если contact не найден**
   - Проверка: не падает на ошибке
   - Проверка: сделка создана с contactId = null

3. ✅ **Batch > 1000 строк**
   - Проверка: обработано 1500 строк
   - Проверка: все созданы в БД

4. ✅ **Транзакция на batch**
   - Проверка: 2000 строк обработано
   - Проверка: 2 batch по 1000 строк

5. ✅ **Обработка ошибок валидации**
   - Проверка: ошибки собраны по строкам
   - Проверка: валидные созданы, невалидные пропущены

6. ✅ **Обработка даты в expectedCloseAt**
   - Проверка: дата парсится корректно
   - Проверка: сохранена в БД

7. ✅ **Обработка tags для сделок**
   - Проверка: tags парсятся
   - Проверка: сохранены в БД

---

### import-batch.service.spec.ts

#### batchFindContactsByEmailOrPhone() - 4 теста

1. ✅ **Поиск по email**
2. ✅ **Поиск по phone**
3. ✅ **Поиск по email или phone**
4. ✅ **Пустой результат**

#### batchCreateContacts() - 4 теста

1. ✅ **Batch создание контактов**
2. ✅ **Обновление существующих**
3. ✅ **Обработка ошибок нормализации**
4. ✅ **Batch > 1000 контактов**

#### batchCreateDeals() - 3 теста

1. ✅ **Batch создание сделок**
2. ✅ **Batch > 1000 сделок**
3. ✅ **Пропуск дубликатов (skipDuplicates)**

---

## Итого

- **Всего тестов**: 26
- **Покрытие**: Все основные сценарии
- **Тип тестов**: Integration (реальная БД)
- **Изоляция**: Очистка БД перед каждым тестом

---

## Запуск

```bash
# Все тесты
npm test

# Только CSV импорт
npm test -- csv-import.service.spec.ts

# Только batch
npm test -- import-batch.service.spec.ts

# С verbose выводом
npm test -- --verbose
```

