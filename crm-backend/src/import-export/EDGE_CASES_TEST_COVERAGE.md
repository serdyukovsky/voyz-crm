# Edge Cases Test Coverage - CSV Import

## Покрытие edge cases

### importContacts - Edge Cases (8 тестов)

1. ✅ **CSV с разделителем `;`**
   - Проверка: сервис обрабатывает разделитель `;`
   - Проверка: корректные строки импортируются
   - Проверка: importResult валиден

2. ✅ **CSV с BOM (Byte Order Mark)**
   - Проверка: сервис обрабатывает UTF-8 BOM (`\uFEFF`)
   - Проверка: не падает на BOM
   - Проверка: данные корректно импортируются

3. ✅ **Пустые строки**
   - Проверка: пустые строки пропускаются
   - Проверка: валидные строки обрабатываются
   - Проверка: сервис не падает

4. ✅ **Лишние колонки**
   - Проверка: лишние колонки игнорируются
   - Проверка: только маппированные поля обрабатываются
   - Проверка: валидные строки импортируются

5. ✅ **Отсутствует mapping для обязательного поля**
   - Проверка: ошибки собираются для всех строк
   - Проверка: ошибки содержат информацию о поле
   - Проверка: сервис не падает

6. ✅ **Email с пробелами**
   - Проверка: email нормализуются (пробелы удаляются)
   - Проверка: email приводятся к lowercase
   - Проверка: валидные строки импортируются

7. ✅ **Phone в разных форматах**
   - Проверка: phone нормализуются в E.164 format
   - Проверка: разные форматы обрабатываются:
     - `8 (999) 123-45-67` → `+79991234567`
     - `+7 999 765 43 21` → `+79997654321`
     - `89991112233` → `+79991112233`
   - Проверка: все форматы корректно обработаны

8. ✅ **Смешанные валидные и невалидные строки**
   - Проверка: сервис не падает
   - Проверка: валидные строки импортируются
   - Проверка: ошибки собираются для невалидных
   - Проверка: importResult валиден

9. ✅ **importResult всегда валиден**
   - Проверка: не выбрасывается исключение
   - Проверка: все поля summary присутствуют
   - Проверка: все поля summary - числа
   - Проверка: errors - массив

---

### importDeals - Edge Cases (5 тестов)

1. ✅ **CSV с разделителем `;` для сделок**
   - Проверка: разделитель `;` обрабатывается
   - Проверка: сделки создаются корректно

2. ✅ **Пустые строки в CSV для сделок**
   - Проверка: пустые строки пропускаются
   - Проверка: валидные строки обрабатываются

3. ✅ **Отсутствует mapping для обязательного поля (number)**
   - Проверка: ошибки собираются
   - Проверка: ошибка содержит информацию о поле

4. ✅ **Смешанные валидные и невалидные строки для сделок**
   - Проверка: сервис не падает
   - Проверка: валидные создаются
   - Проверка: ошибки собираются

5. ✅ **importResult всегда валиден для сделок**
   - Проверка: не выбрасывается исключение
   - Проверка: все поля присутствуют
   - Проверка: errors - массив

---

## Проверки безопасности

### ✅ Сервис не падает

Все тесты проверяют, что:
- Сервис не выбрасывает необработанные исключения
- Все ошибки обрабатываются в try-catch
- importResult всегда возвращается

### ✅ Ошибки собираются

Все тесты проверяют, что:
- Ошибки добавляются в массив `errors`
- Ошибки содержат номер строки
- Ошибки содержат причину (error message)
- Ошибки содержат поле (field), если применимо

### ✅ Корректные строки импортируются

Все тесты проверяют, что:
- Валидные строки обрабатываются даже при наличии невалидных
- Невалидные строки не блокируют обработку валидных
- Данные корректно сохраняются в БД

### ✅ importResult всегда валиден

Все тесты проверяют, что:
- `result` определен
- `result.summary` определен
- Все поля `summary` присутствуют:
  - `total: number`
  - `created: number`
  - `updated: number`
  - `failed: number`
  - `skipped: number`
- `result.errors` - массив

---

## Форматы данных

### Email нормализация

- Пробелы удаляются: `  ivan@example.com  ` → `ivan@example.com`
- Приводится к lowercase: `IVAN@EXAMPLE.COM` → `ivan@example.com`

### Phone нормализация

- `8 (999) 123-45-67` → `+79991234567`
- `+7 999 765 43 21` → `+79997654321`
- `89991112233` → `+79991112233`
- `+79994445566` → `+79994445566` (уже в E.164)

---

## Итого

- **Всего edge-case тестов**: 13
- **Покрытие**: Все основные edge cases
- **Безопасность**: Проверка на падения, сбор ошибок, валидность результата
- **Форматы**: Разделители, BOM, пустые строки, лишние колонки
- **Валидация**: Обязательные поля, нормализация данных

---

## Запуск

```bash
# Все edge-case тесты
npm test -- csv-import.service.spec.ts --testNamePattern="Edge Cases"

# Только для контактов
npm test -- csv-import.service.spec.ts --testNamePattern="Edge Cases - importContacts"

# Только для сделок
npm test -- csv-import.service.spec.ts --testNamePattern="Edge Cases - importDeals"
```

