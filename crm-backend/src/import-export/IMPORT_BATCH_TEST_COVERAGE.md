# ImportBatchService Test Coverage

## Покрытие тестами

### batchFindContactsByEmailOrPhone - 5 тестов

1. ✅ **Находит существующие контакты по email**
   - Проверка: возвращает Map
   - Проверка: структура значений (id, email, phone)
   - Проверка: **ОДИН запрос** к БД (не N+1)

2. ✅ **Находит существующие контакты по phone**
   - Проверка: один запрос
   - Проверка: корректный ключ в Map (`phone:+79991234567`)

3. ✅ **Находит контакты по email ИЛИ phone в одном запросе**
   - Проверка: **ОДИН запрос** с OR условием
   - Проверка: структура запроса (OR: [{email}, {phone}])
   - Проверка: оба контакта найдены

4. ✅ **Возвращает пустой Map если нет совпадений**
   - Проверка: запрос выполнен
   - Проверка: Map пустой

5. ✅ **Возвращает пустой Map без запроса если массивы пустые**
   - Проверка: запрос **НЕ выполнен**
   - Проверка: Map пустой

---

### batchCreateContacts - 7 тестов

1. ✅ **Создает новые контакты через createMany**
   - Проверка: используется `createMany` (не отдельные `create`)
   - Проверка: используется транзакция
   - Проверка: `skipDuplicates: true`
   - Проверка: все созданы в БД

2. ✅ **Обновляет существующие контакты**
   - Проверка: `updated = 1`
   - Проверка: поля обновлены в БД

3. ✅ **Создает новые И обновляет существующие в одном batch**
   - Проверка: `created = 2`, `updated = 1`
   - Проверка: все операции в одном batch
   - Проверка: существующий обновлен, новые созданы

4. ✅ **Не создает дубликаты по email**
   - Проверка: только один контакт создан
   - Проверка: первый контакт сохранен

5. ✅ **Не создает дубликаты по phone**
   - Проверка: только один контакт создан

6. ✅ **Обрабатывает ошибки нормализации**
   - Проверка: валидные созданы
   - Проверка: ошибки собраны

7. ✅ **Batch > 1000 контактов делится на несколько транзакций**
   - Проверка: **3 транзакции** для 2500 контактов (2500 / 1000 = 2.5 → 3)
   - Проверка: все созданы в БД
   - Проверка: используется `$transaction` для каждого batch

---

### batchCreateDeals - 6 тестов

1. ✅ **Корректно создает сделки**
   - Проверка: все поля сохранены
   - Проверка: `created = 2`

2. ✅ **Batch > 1000 сделок делится на несколько транзакций**
   - Проверка: **3 транзакции** для 2500 сделок
   - Проверка: все созданы в БД
   - Проверка: используется `$transaction` для каждого batch

3. ✅ **Пропускает дубликаты по number (skipDuplicates)**
   - Проверка: только новая создана
   - Проверка: существующая не изменена

4. ✅ **Откатывает транзакцию при ошибке в batch**
   - Проверка: ошибки собраны
   - Проверка: валидные созданы (или откатились, зависит от реализации)

5. ✅ **Корректно создает сделки с разными полями**
   - Проверка: amount, budget, description, tags, expectedCloseAt
   - Проверка: все поля сохранены корректно

6. ✅ **Обрабатывает batch > 1000 сделок**
   - Проверка: все созданы
   - Проверка: нет ошибок

---

## Проверки производительности

### Количество запросов

- ✅ `batchFindContactsByEmailOrPhone`: **1 запрос** (независимо от количества email/phone)
- ✅ `batchCreateContacts`: **1 транзакция** на batch (1000 записей)
- ✅ `batchCreateDeals`: **1 транзакция** на batch (1000 записей)

### Batch операции

- ✅ Используется `createMany` для контактов (не отдельные `create`)
- ✅ Используется `createMany` для сделок (не отдельные `create`)
- ✅ Batch size = 1000
- ✅ Транзакции для каждого batch

### Update и Create в одном batch

- ✅ Контакты: новые и обновляемые обрабатываются в одном batch
- ✅ Разделение на `toCreate` и `toUpdate` происходит до batch обработки
- ✅ Оба типа операций выполняются в транзакциях

---

## Итого

- **Всего тестов**: 18
- **Покрытие**: Все основные сценарии
- **Тип тестов**: Integration (реальная БД)
- **Изоляция**: Очистка БД перед каждым тестом
- **Проверка запросов**: Моки для подсчета вызовов Prisma

---

## Запуск

```bash
# Все тесты ImportBatchService
npm test -- import-batch.service.spec.ts

# С verbose выводом
npm test -- import-batch.service.spec.ts --verbose

# С coverage
npm test -- import-batch.service.spec.ts --coverage
```

