# Tech Lead Verdict - Database & CSV Import

## 1. МОЖНО ЛИ ОСТАВАТЬСЯ НА ТЕКУЩЕЙ БД

**ДА. PostgreSQL — оптимальный выбор.**

**Почему:**
- ✅ Отличная поддержка bulk insert (COPY FROM, createMany)
- ✅ ACID транзакции для целостности данных
- ✅ Индексы и constraints для уникальности
- ✅ JSONB для гибких полей (social, payload)
- ✅ Массив типов (tags String[])
- ✅ Масштабируемость для 10k-100k строк

**Альтернативы не нужны:**
- ❌ MySQL — хуже с JSON, нет массивов
- ❌ MongoDB — нет транзакций, проблемы с уникальностью
- ❌ SQLite — не для production, блокировки

---

## 2. ЕСЛИ НЕТ — НА КАКУЮ ПЕРЕЙТИ

**Не требуется.** PostgreSQL подходит.

---

## 3. ОБЯЗАТЕЛЬНЫЕ ИЗМЕНЕНИЯ ДО ИМПОРТА

### Schema (Prisma):
1. ✅ `Contact.email @unique` — предотвратить дубликаты
2. ✅ `Contact.phone @unique` — предотвратить дубликаты  
3. ✅ `Company.name @unique` — предотвратить дубликаты
4. ✅ Индексы: `Deal.companyId`, `Deal.updatedAt`, `Deal.[pipelineId, stageId]`

### Code (обязательно):
1. ✅ Batch проверка существующих (1 запрос вместо 10k)
2. ✅ `createMany` для новых контактов (batch insert)
3. ✅ Batch создание activities
4. ✅ Транзакции для batch'ов (по 1000 строк)
5. ✅ Отключить WebSocket при импорте
6. ✅ Отключить `getStats()` при импорте

**Без этого:** Импорт упадет по timeout или создаст дубликаты.

---

## 4. ЧТО МОЖНО ОТЛОЖИТЬ

### Schema (можно позже):
- Partial индексы (deals_active, tasks_overdue)
- GIN индексы для массивов (tags)
- Денормализация (stageName, contactName в Deal)

### Code (можно позже):
- Queue система (Bull/BullMQ) — можно делать синхронно сначала
- Raw SQL (COPY FROM) — createMany достаточно для 10k
- Параллельная обработка batch'ов — риск deadlocks
- Кеширование проверок — не критично для 10k

### Performance (можно позже):
- Оптимизация N+1 в findAll() — не влияет на импорт
- Select оптимизации — не влияет на импорт
- WebSocket оптимизации — не влияет на импорт

---

## ПРИОРИТЕТЫ

**Критично (до импорта):**
1. Unique constraints в schema
2. Batch операции в коде
3. Транзакции для batch'ов

**Важно (можно после первого импорта):**
1. Queue система для фоновой обработки
2. Дополнительные индексы

**Опционально (когда будет 100k+ строк):**
1. Raw SQL (COPY FROM)
2. Параллельная обработка
3. Денормализация

---

**Вердикт: PostgreSQL остается. Исправить batch операции и unique constraints — можно импортировать.**

