# Тестирование CSV импорта

Этот документ описывает, как протестировать функциональность импорта CSV.

## Тестовые файлы

### test-contacts.csv
Тестовый CSV файл для импорта контактов с полями:
- `fullName` - Полное имя (обязательно)
- `email` - Email адрес
- `phone` - Номер телефона
- `position` - Должность
- `companyName` - Название компании
- `tags` - Теги (через запятую)
- `notes` - Заметки

### test-deals.csv
Тестовый CSV файл для импорта сделок с полями:
- `Название сделки` - Название (маппится на `title`)
- `Тип` - Тип сделки
- `Стадия сделки` - Стадия (маппится на `stageId`)
- `Контакт` - Email контакта (маппится на `email`)
- `Компания` - Название компании
- `Сумма` - Сумма сделки (маппится на `amount`)
- `Валюта` - Валюта
- `Ответственный` - Ответственный пользователь
- `Дата создания` - Дата создания
- `Описание` - Описание (маппится на `description`)

## Тестирование через UI

1. Запустите фронтенд и бэкенд
2. Авторизуйтесь в системе
3. Перейдите на страницу "Импорт / Экспорт"
4. Выберите тип импорта (Контакты или Сделки)
5. Загрузите тестовый CSV файл
6. Проверьте предпросмотр данных
7. Настройте маппинг полей (если нужно)
8. Запустите dry-run для проверки
9. Если все ок, выполните реальный импорт

## Тестирование через API (Node.js скрипт)

### Установка зависимостей

```bash
npm install form-data node-fetch@2
```

### Получение токена

1. Авторизуйтесь в приложении
2. Откройте консоль браузера (F12)
3. Выполните: `localStorage.getItem('access_token')`
4. Скопируйте токен

### Запуск теста

```bash
# Установите токен
export AUTH_TOKEN="your-jwt-token-here"

# Тест импорта контактов (dry-run)
node test-import.js contact test-contacts.csv

# Тест импорта контактов (реальный импорт)
node test-import.js contact test-contacts.csv false

# Тест импорта сделок (dry-run)
node test-import.js deal test-deals.csv

# Тест импорта сделок (реальный импорт)
node test-import.js deal test-deals.csv false
```

### Использование bash скрипта

```bash
# Установите токен
export AUTH_TOKEN="your-jwt-token-here"

# Запустите тест
chmod +x test-import-contacts.sh
./test-import-contacts.sh
```

## Ожидаемые результаты

### Импорт контактов (dry-run)
- ✅ Всего строк: 5
- ✅ Создано: 5 (или меньше, если есть дубликаты)
- ✅ Обновлено: 0 (или больше, если есть существующие контакты)
- ✅ Ошибок: 0

### Импорт сделок (dry-run)
⚠️ **Важно**: Для импорта сделок нужно указать `pipelineId` и `stageId` в маппинге.

Если эти поля не указаны, импорт завершится с ошибкой:
```
Mapping must include number, title, pipelineId, and stageId fields
```

## Отладка

### Проблема: "Failed to fetch"
- Проверьте, что бэкенд запущен
- Проверьте URL в `VITE_API_URL` (должен быть `http://localhost:3001/api`)
- Проверьте CORS настройки

### Проблема: "Not authenticated"
- Проверьте, что токен установлен и действителен
- Перелогиньтесь и получите новый токен

### Проблема: "Mapping must include..."
- Проверьте маппинг полей
- Убедитесь, что обязательные поля указаны

### Проблема: "File must be a CSV file"
- Проверьте расширение файла (должно быть `.csv`)
- Проверьте содержимое файла (должен быть валидный CSV)

## Создание своих тестовых файлов

### Формат CSV для контактов

```csv
fullName,email,phone,position,companyName,tags,notes
Иван Иванов,ivan@example.com,+79991234567,Менеджер,ООО "Компания",клиент,Важный клиент
```

### Формат CSV для сделок

```csv
Название сделки,Сумма,Email контакта,Описание
Сделка 1,100000,ivan@example.com,Описание сделки
```

**Важно**: Для сделок нужно также указать `pipelineId` и `stageId` в маппинге или в CSV (если они есть в системе).

## Дополнительная информация

- Все тесты выполняются в режиме dry-run по умолчанию
- Для реального импорта добавьте параметр `false` в конец команды
- Результаты импорта выводятся в консоль
- Ошибки отображаются с деталями (строка, поле, значение)

